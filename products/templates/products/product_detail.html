{% extends 'base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ product.name }} | جزئیات و خرید{% endblock %}

{% block content %}
<div class="container">
    <style>
        :root {
            --accent-color: #ff4757;
            --dark-blue: #2c3e50;
            --border-color: #e1e1e1;
        }

        /* --- حل مشکل بیرون‌زدگی (مهم) --- */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 15px;
            /* فاصله امن از لبه‌ها */
        }

        .product-page-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.03);
            margin-top: 20px;
            padding: 30px;
            /* جلوگیری از سرریز محتوا */
            overflow: hidden;
            max-width: 100%;
        }

        .product-grid {
            display: grid;
            /* تغییر درصد به fr برای جلوگیری از بیرون‌زدگی */
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 25px;
        }

        /* --- ۱. گالری --- */
        .main-img-box {
            width: 100%;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            margin-bottom: 15px;
            background: #fff;
            padding: 10px;
        }

        .main-img-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .thumbnails-row {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            justify-content: center;
        }

        .thumb-img {
            width: 60px;
            height: 60px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            object-fit: contain;
            padding: 5px;
        }

        .thumb-img.active {
            border-color: var(--accent-color);
        }

        /* --- ۲. اطلاعات --- */
        .product-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--dark-blue);
            margin: 10px 0 20px;
        }

        /* لیست ویژگی‌های داینامیک */
        .features-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
        }

        .features-list li {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 8px;
            display: flex;
            align-items: start;
            gap: 8px;
        }

        .features-list li::before {
            content: "✔";
            color: #2ecc71;
            font-weight: bold;
        }

        .desc-box {
            margin-top: 20px;
            color: #444;
            line-height: 1.8;
            font-size: 0.95rem;
            text-align: justify;
        }

        /* --- ۳. باکس خرید --- */
        .buy-card {
            background: #fdfdfd;
            border: 2px solid #f1f2f6;
            border-radius: 16px;
            padding: 20px;
            position: sticky;
            top: 110px;
        }

        .final-price {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--dark-blue);
        }

        .discount-pill {
            background: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .qty-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            width: 110px;
        }

        .qty-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
        }

        .qty-input-field {
            width: 40px;
            text-align: center;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .btn-add-cart {
            width: 100%;
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
        }

        .btn-add-cart:hover {
            background: #ff3043;
        }

        /* ریسپانسیو */
        @media (max-width: 992px) {
            .product-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .buy-card {
                display: none;
            }

            /* باکس خرید دسکتاپ حذف */
            .main-img-box {
                height: 300px;
            }
        }

        .mobile-buy-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            align-items: center;
            justify-content: space-between;
        }

        @media (max-width: 992px) {
            .mobile-buy-bar {
                display: flex;
            }
        }
    </style>

    <div class="product-page-wrapper">
        <div class="product-grid">

            <!-- گالری -->
            <div class="gallery-col">
                <div class="main-img-box">
                    {% if product.image %}
                    <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}">
                    {% else %}
                    <div style="color: #ccc;">بدون تصویر</div>
                    {% endif %}
                </div>
                <div class="thumbnails-row">
                    {% if product.image %}
                    <img src="{{ product.image.url }}" class="thumb-img active" onclick="changeImage(this)">
                    {% endif %}
                    {% for img in product.images.all %}
                    <img src="{{ img.image.url }}" class="thumb-img" onclick="changeImage(this)">
                    {% endfor %}
                </div>
            </div>

            <!-- اطلاعات -->
            <div class="info-col">
                <div style="font-size: 0.85rem; color: #888; margin-bottom: 10px;">دسته: {{ product.get_category_display
                    }}</div>
                <h1 class="product-title">{{ product.name }}</h1>

                <!-- لیست ویژگی‌های داینامیک -->
                {% if product.get_features_list %}
                <ul class="features-list">
                    {% for feature in product.get_features_list %}
                    {% if feature|length > 1 %} <!-- حذف خطوط خالی -->
                    <li>{{ feature }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
                {% else %}
                <!-- حالت پیش‌فرض اگر ویژگی وارد نشده بود -->
                <ul class="features-list">
                    <li>ضمانت اصالت و سلامت فیزیکی کالا</li>
                </ul>
                {% endif %}

                <div class="desc-box">
                    <h4>توضیحات محصول</h4>
                    <p>{{ product.description|linebreaks }}</p>
                </div>
            </div>

            <!-- باکس خرید -->
            <div class="buy-box-col">
                <div class="buy-card">
                    <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <span style="color: #777;">فروشنده:</span> <strong>{{
                            product.seller.get_full_name|default:product.seller.username }}</strong>
                    </div>

                    <div style="margin-bottom: 20px;">
                        {% if product.discount_price %}
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <del style="color:#aaa;">{{ product.price|intcomma }}</del>
                            <span class="discount-pill">{{ product.get_discount_percent }}%</span>
                        </div>
                        <div class="final-price">{{ product.discount_price|intcomma }} <small
                                style="font-size:1rem; font-weight:400;">تومان</small></div>
                        {% else %}
                        <div class="final-price">{{ product.price|intcomma }} <small
                                style="font-size:1rem; font-weight:400;">تومان</small></div>
                        {% endif %}
                    </div>

                    <form action="{% url 'cart:cart_add' product.id %}" method="post" id="desktop-buy-form">
                        {% csrf_token %}
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>تعداد:</span>
                            <div class="qty-wrapper">
                                <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
                                {{ cart_product_form.quantity }}
                                <button type="button" class="qty-btn" onclick="updateQty(-1)">-</button>
                            </div>
                        </div>
                        {{ cart_product_form.update }}
                        <button type="submit" class="btn-add-cart">افزودن به سبد خرید</button>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- نوار موبایل -->
<div class="mobile-buy-bar">
    <div>
        {% if product.discount_price %}
        <div style="font-weight: 800; font-size: 1.1rem;">{{ product.discount_price|intcomma }} تومان</div>
        {% else %}
        <div style="font-weight: 800; font-size: 1.1rem;">{{ product.price|intcomma }} تومان</div>
        {% endif %}
    </div>
    <button onclick="document.getElementById('desktop-buy-form').submit()"
        style="background: var(--accent-color); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold;">افزودن</button>
</div>

<script>
    function changeImage(el) {
        document.getElementById('mainImage').src = el.src;
        document.querySelectorAll('.thumb-img').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
    }
    function updateQty(n) {
        const input = document.getElementById('id_quantity');
        let val = parseInt(input.value) || 1;
        val = Math.max(1, val + n);
        input.value = val;
    }
    window.onload = function () {
        const input = document.getElementById('id_quantity');
        if (input) {
            input.className = 'qty-input-field';
            input.style.width = '40px'; input.style.border = 'none';
        }
    }
</script>
{% endblock %}